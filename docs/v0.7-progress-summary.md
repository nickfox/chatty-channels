# ChattyChannels v0.7 Progress Summary - VU Meter OSC Integration

## Current Status: Partially Complete
**Date**: May 29, 2025  
**Goal**: Get VU meters to follow real kick drum RMS data from Logic Pro instead of test data

## What Was Accomplished

### 1. ✅ OSC Listener Implementation (COMPLETE)
- **Created**: `OSCListener.swift` - New service to receive incoming OSC messages
- **Features**: 
  - Listens on UDP port 9001-9005 (tries multiple ports if 9001 in use)
  - Parses incoming OSC messages from AIPlayer plugin
  - Routes messages to appropriate handlers
  - Handles Swift 6 concurrency properly with `@unchecked Sendable`
- **Integration**: Added to `ChattyChannelsApp.swift` with proper initialization
- **Status**: ✅ Compiles and starts successfully

### 2. ✅ Simulation Service Disabled (COMPLETE)  
- **Fixed**: `ChattyChannelsApp.swift` - Disabled auto-start of simulation in debug mode
- **Result**: No more fake test data overriding real OSC data
- **Status**: ✅ Test data no longer interferes with real data

### 3. ✅ VU Meter Display Logic Updated (COMPLETE)
- **Fixed**: `VUMeterView.swift` - Changed from hardcoded `MASTER_BUS_UUID` to dynamic track selection
- **Logic**: Now automatically displays the most recently active track (whoever is sending RMS data)
- **Result**: VU meters will follow whichever track sends OSC data most recently
- **Status**: ✅ Ready to display real kick drum data

### 4. ⚠️ AppleScript Track Enumeration (IN PROGRESS - BLOCKED)
- **Problem**: Logic Pro 11.2 has very limited AppleScript dictionary
- **Research Done**: 
  - Standard `every track`, `every audio track` syntax doesn't exist in Logic Pro
  - Must use System Events UI automation instead
  - Requires Accessibility permissions (✅ granted)
- **Current Issue**: AppleScript gets "AppleEvent handler failed" when trying to extract track names
- **Investigation**: 
  - Logic Pro window structure analyzed: 9 UI elements, 4 groups identified
  - Groups contain Control Bar, not actual track data
  - Track names location in UI hierarchy still unknown

## Technical Architecture (Working)

```
AIPlayer Plugin (Logic Pro) 
    ↓ OSC Messages (port 9001-9005)
OSCListener.swift 
    ↓ processIdentifiedRMS()
OSCService.swift 
    ↓ updateLevel()
LevelMeterService.swift 
    ↓ @Published audioLevels
VUMeterView.swift (displays most recent track)
```

## Current Blocking Issue

**AppleScript Calibration Failure**: Cannot enumerate track names from Logic Pro 11.2
- **Error**: `AppleEvent handler failed (-10000)`
- **Root Cause**: Logic Pro 11.2 has extremely limited AppleScript support - no track objects exist
- **Investigation Results**: After extensive testing with System Events UI automation:
  - Window contains 9 UI elements: 3 buttons, 1 image, 1 static text, 4 groups
  - Group 6: Control bar with transport controls (19 elements)
  - Group 7: Contains a list element but it always has 0 rows
  - Groups 8-9: Inspector areas with settings but no track names
  - No accessible track names found anywhere in the UI
- **Impact**: Cannot complete calibration using the original AppleScript approach

## New Approach: MIDI Learn Track Identification

### Why MIDI?
Since Logic Pro doesn't expose track names via AppleScript or System Events, we need an alternative approach. MIDI is a viable option because:
- Logic Pro has built-in MIDI control capabilities
- Volume faders can be assigned to MIDI CC messages
- We can correlate MIDI control changes with plugin RMS detection

### Proposed MIDI Learn Workflow
1. **Setup**: Assign each Logic track's volume fader to a unique MIDI CC
2. **Calibration**: 
   - Move each fader (triggering MIDI CC)
   - Detect which AIPlayer plugin shows RMS change
   - Map MIDI CC → Plugin → Track
3. **Operation**: Use MIDI CC instead of AppleScript for volume control

### Testing Approach
We're using `/Users/nickfox137/Documents/chatty-channel/test_applescript.sh` as our test harness for exploring Logic Pro's capabilities. This script has been used to:
- Test AppleScript track enumeration (failed - no track objects)
- Explore System Events UI structure (found no accessible track names)
- Will be updated to test MIDI capabilities

## What Needs To Be Done Next

### Priority 1: Implement MIDI Learn System
1. **Research Logic Pro MIDI implementation**
   - How to assign MIDI CC to track faders
   - How to send/receive MIDI in the Control Room app
2. **Update test_applescript.sh** to explore MIDI capabilities
3. **Design MIDI-based calibration flow**
4. **Implement MIDI handling in OSCService or new MIDIService**

### Priority 2: Test Complete Pipeline  
1. **Run calibration** with AIPlayer plugin on kick track
2. **Verify OSC messages** are received by OSCListener
3. **Confirm VU meters** update with real kick drum data
4. **Test track switching** and display logic

## Files Modified

### New Files Created:
- `ChattyChannels/Services/OSCListener.swift` - OSC message receiver

### Files Modified:
- `ChattyChannelsApp.swift` - Added OSCListener, disabled simulation
- `VUMeterView.swift` - Dynamic track selection instead of MASTER_BUS_UUID  
- `TrackMappingService.swift` - System Events AppleScript (needs UI path fix)

## Console Messages (Working)
```
OSC Listener started successfully on port 9001
[OSCService] Initialized. LevelMeterService is set.
```

## Console Messages (Failing)
```
AppleScript execution failed: System Events got an error: AppleEvent handler failed. (-10000)
Calibration Failed: AppleScript execution failed...
```

## Key Insight for Next Session

The **OSC pipeline is ready and working**. The **only remaining issue** is finding the correct AppleScript UI element path to access track names in Logic Pro 11.2's interface. Once that's discovered, calibration should complete and VU meters should start following the kick drum.

## System Requirements Confirmed
- ✅ Logic Pro 11.2 running
- ✅ AIPlayer plugin loaded on kick track  
- ✅ Accessibility permissions granted to Terminal/Script Editor
- ✅ OSC communication functional (listener starts successfully)

## Investigation History

### AppleScript Attempts (Failed)
- Tried `count of tracks` - "The variable tracks is not defined"
- Tried `every audio track` - "Expected class name but found identifier"
- Tried `channel strips` - Not recognized
- Logic Pro only exposes: application object, document object, play/stop commands

### System Events UI Automation (Failed)
- Found window structure but no track names
- Group 2 has a list element that should contain tracks, but always shows 0 rows
- Checked all static texts, text fields, buttons - no track names found
- Track names are likely drawn directly or in a custom control not exposed to accessibility APIs

### Current test_applescript.sh Usage
The script is our primary tool for testing Logic Pro integration:
```bash
#!/bin/bash
# Located at: /Users/nickfox137/Documents/chatty-channel/test_applescript.sh
# Usage: ./test_applescript.sh
# Purpose: Test various approaches to interact with Logic Pro
```

Recent tests included:
- Window enumeration
- UI element exploration  
- Group content inspection
- List/table detection
- Static text extraction

## Next Steps Summary
1. Pivot to MIDI-based approach for track identification
2. Research Logic Pro's MIDI implementation options
3. Test MIDI CC assignment and detection
4. Implement new calibration flow using MIDI instead of AppleScript track names
