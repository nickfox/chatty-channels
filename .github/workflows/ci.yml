name: AIplayer CI
on: [push]
jobs:
  build-and-test-cpp:
    name: Build & Test AIplayer
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Debug Git Submodules
        run: |
          echo "Checking Git submodules..."
          git submodule status
          git submodule foreach git status

      - name: Debug Directory Structure
        run: |
          echo "Current directory structure:"
          pwd
          ls -la
          echo "AIplayer directory:"
          ls -la ./AIplayer || echo "AIplayer directory not found"
          echo "AIplayer/AIplayer directory:"
          ls -la ./AIplayer/AIplayer || echo "AIplayer/AIplayer directory not found"
          
      - name: Clone JUCE Directly
        run: |
          # Clone JUCE directly into the expected location
          cd AIplayer/AIplayer
          mkdir -p ../JUCE
          git clone --depth 1 https://github.com/juce-framework/JUCE.git ../JUCE
          
      - name: Verify JUCE Clone
        run: |
          echo "Verifying JUCE clone..."
          ls -la AIplayer/JUCE/modules || echo "JUCE modules not found in AIplayer/JUCE"
          
      - name: Install CMake + Ninja
        run: brew install cmake ninja
        
      - name: Configure CMake
        working-directory: AIplayer/AIplayer
        run: |
          # Using the known path to JUCE modules
          cmake -S . -B build \
                -G Ninja \
                -DCMAKE_BUILD_TYPE=Debug \
                -DJUCE_MODULES_DIR=$PWD/../JUCE/modules
          
      - name: Check CMake Configuration
        working-directory: AIplayer/AIplayer
        run: |
          echo "Checking CMake cache..."
          cat build/CMakeCache.txt | grep JUCE
          
      - name: Build Project
        working-directory: AIplayer/AIplayer
        run: cmake --build build --config Debug -- -v
        
      - name: Run C++ Tests (CTest)
        working-directory: AIplayer/AIplayer
        run: ctest --test-dir build --output-on-failure
        
      - name: Install AU Plugin for Validation
        run: |
          mkdir -p ~/Library/Audio/Plug-Ins/Components
          cp -r AIplayer/AIplayer/build/AIplayer_artefacts/Debug/AIplayer.component \
                ~/Library/Audio/Plug-Ins/Components/ || echo "Failed to copy component, may not exist at expected path"
                
      - name: Validate AU Plugin with auval
        run: auval -v aufx Dm4q Manu || echo "auval failed - this may be expected in CI environment"
        
      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build-logs
          path: |
            AIplayer/AIplayer/build/CMakeFiles/CMakeOutput.log
            AIplayer/AIplayer/build/CMakeFiles/CMakeError.log
          if-no-files-found: warn
          retention-days: 7
