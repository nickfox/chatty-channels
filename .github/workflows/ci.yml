name: CI
on: [push]
jobs:
  build-and-test-swift:
    runs-on: macos-15 # macos-15 confirmed to have Xcode 16.3
    env:
      ACTIONS_STEP_DEBUG: true
    steps:
      - uses: actions/checkout@v4
      - name: List available Xcode versions
        run: ls -la /Applications | grep Xcode
      - uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: '16.3.0' # Try 16.3.0 instead of 16.3
      - name: Verify Xcode version
        run: xcodebuild -version
      - name: List root directory contents
        run: ls -la
      - name: List ChattyChannels directory contents
        run: ls -la ChattyChannels
      - name: Check project file permissions
        working-directory: ./ChattyChannels
        run: ls -la ChattyChannels.xcodeproj
      - name: List available schemes
        working-directory: ./ChattyChannels
        run: xcodebuild -list -project ChattyChannels.xcodeproj
      - name: Build
        working-directory: ./ChattyChannels
        run: |
          xcodebuild -project ChattyChannels.xcodeproj \
                     -scheme ChattyChannels \
                     -configuration Debug \
                     build \
                     CODE_SIGNING_ALLOWED=NO
      - name: Run unit tests
        working-directory: ./ChattyChannels
        run: |
          xcodebuild test -project ChattyChannels.xcodeproj \
                          -scheme ChattyChannels \
                          -destination 'platform=macOS' \
                          CODE_SIGNING_ALLOWED=NO
      - name: Upload test logs
        uses: actions/upload-artifact@v3
        with:
          name: swift-test-logs
          path: ./ChattyChannels/build/logs
          
  build-and-test-cpp:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Install CMake and Catch2
        run: brew install cmake catch2
      - name: Configure CMake
        working-directory: ./AIplayer
        run: cmake --preset juce -DCMAKE_BUILD_TYPE=Debug
      - name: Build AIplayer
        working-directory: ./AIplayer
        run: cmake --build --preset juce-debug
      - name: Run Tests
        working-directory: ./AIplayer
        run: ctest --output-on-failure --preset juce-debug
      - name: Upload manual integration test log
        uses: actions/upload-artifact@v3
        with:
          name: iteration_v0.5.log
          path: ./docs/logs/iteration_v0.5.log
