name: AIplayer CI (Fix Paths)
on: [push]
jobs:
  fix-and-build:
    name: Fix Paths and Build AIplayer
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: '16.3.0'
      
      - name: Clone JUCE
        run: |
          # Clone JUCE to a consistent location
          git clone --depth 1 https://github.com/juce-framework/JUCE.git /tmp/JUCE
          
      - name: Replace hardcoded paths in project file
        run: |
          # Find and fix the Xcode project file
          find AIplayer -name "*.xcodeproj" -type d -exec find {} -name "project.pbxproj" \; | while read PROJECT_FILE; do
            echo "Fixing paths in $PROJECT_FILE"
            sed -i '' 's|/Users/nickfox137/Downloads/JUCE|/tmp/JUCE|g' "$PROJECT_FILE"
          done
          
      - name: Skip VST3 Manifest Helper
        run: |
          # Find the Xcode project file
          PROJECT_FILE=$(find AIplayer -name "*.xcodeproj" -type d -exec find {} -name "project.pbxproj" \; | head -n 1)
          
          # Disable VST3 Manifest Helper from the build
          echo "Disabling VST3 Manifest Helper in $PROJECT_FILE"
          sed -i '' '/name = "AIplayer - VST3 Manifest Helper"/,/};/s/buildSettings/buildSettings = { ENABLE_TESTABILITY = NO; };/g' "$PROJECT_FILE"
          
      - name: Build AIplayer (AU only)
        run: |
          # Build only the AU component
          cd AIplayer/AIplayer/Builds/MacOSX
          xcodebuild -project AIplayer.xcodeproj \
                    -scheme "AIplayer - AU" \
                    -configuration Debug \
                    build \
                    CODE_SIGNING_ALLOWED=NO \
                    SKIP_INSTALL=YES
                    
      - name: Find Built Component
        run: |
          echo "Looking for built component:"
          find AIplayer -name "*.component" -type d
