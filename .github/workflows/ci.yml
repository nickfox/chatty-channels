name: AIplayer CI
on: [push]
jobs:
  build-and-test-cpp:
    name: Build & Test AIplayer
    runs-on: macos-15
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Debug Directory Structure
        run: |
          echo "Current directory structure:"
          pwd
          ls -la
          echo "AIplayer directory:"
          ls -la ./AIplayer || echo "AIplayer directory not found"
          echo "AIplayer/AIplayer directory:"
          ls -la ./AIplayer/AIplayer || echo "AIplayer/AIplayer directory not found"
          echo "JUCE directory (if exists):"
          ls -la ./AIplayer/AIplayer/JUCE || echo "JUCE directory not found at expected location"

      - name: Install CMake + Ninja
        run: brew install cmake ninja

      - name: Configure CMake
        working-directory: AIplayer/AIplayer
        run: |
          # Find JUCE directory
          if [ -d "JUCE" ]; then
            echo "Found JUCE in current directory"
            JUCE_MODULES="$PWD/JUCE/modules"
          elif [ -d "../JUCE" ]; then
            echo "Found JUCE in parent directory"
            JUCE_MODULES="$PWD/../JUCE/modules"
          else
            echo "JUCE not found in expected locations, searching..."
            JUCE_DIR=$(find $(pwd)/.. -name "JUCE" -type d | head -n 1)
            if [ ! -z "$JUCE_DIR" ]; then
              echo "Found JUCE at: $JUCE_DIR"
              JUCE_MODULES="$JUCE_DIR/modules"
            else
              echo "ERROR: JUCE directory not found!"
              exit 1
            fi
          fi
          echo "Using JUCE modules at: $JUCE_MODULES"
          ls -la $JUCE_MODULES || echo "Cannot list JUCE modules directory"
          
          cmake -S . -B build \
                -G Ninja \
                -DCMAKE_BUILD_TYPE=Debug \
                -DJUCE_MODULES_DIR=$JUCE_MODULES

      - name: Build Project
        working-directory: AIplayer/AIplayer
        run: cmake --build build --config Debug -- -v

      - name: Run C++ Tests (CTest)
        working-directory: AIplayer/AIplayer
        run: ctest --test-dir build --output-on-failure

      - name: Install AU Plugin for Validation
        run: |
          mkdir -p ~/Library/Audio/Plug-Ins/Components
          cp -r AIplayer/AIplayer/build/AIplayer_artefacts/Debug/AIplayer.component \
                ~/Library/Audio/Plug-Ins/Components/ || echo "Failed to copy component, may not exist at expected path"

      - name: Validate AU Plugin with auval
        run: auval -v aufx Dm4q Manu || echo "auval failed - this may be expected in CI environment"

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cpp-build-logs
          path: |
            AIplayer/AIplayer/build/CMakeFiles/CMakeOutput.log
            AIplayer/AIplayer/build/CMakeFiles/CMakeError.log
          if-no-files-found: warn
          retention-days: 7
